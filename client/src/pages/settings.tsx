import { useState, useEffect, useCallback } from "react";
import { useAuth } from "@/hooks/useAuth";
import { useMutation, useQueryClient } from "@tanstack/react-query";
import { useForm } from "react-hook-form";
import { zodResolver } from "@hookform/resolvers/zod";
import { updateUserProfileSchema, type UpdateUserProfile } from "@shared/schema";
import { apiRequest } from "@/lib/queryClient";
import { useToast } from "@/hooks/use-toast";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from "@/components/ui/form";
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from "@/components/ui/select";
import { User, Gift, Users, ArrowLeft, CreditCard, Shield, Calendar } from "lucide-react";
import { isUnauthorizedError } from "@/lib/authUtils";

export default function Settings() {
  const { user, isLoading } = useAuth();
  const { toast } = useToast();
  const queryClient = useQueryClient();

  const [dateInputFocused, setDateInputFocused] = useState(false);
  const [ageDisplay, setAgeDisplay] = useState("");

  // Calculate age from date of birth
  const calculateAge = useCallback((dateOfBirth: string) => {
    if (!dateOfBirth) return "";
    const today = new Date();
    const birthDate = new Date(dateOfBirth);
    let age = today.getFullYear() - birthDate.getFullYear();
    const monthDiff = today.getMonth() - birthDate.getMonth();
    
    if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
      age--;
    }
    
    if (age < 0) return "Invalid date";
    if (age === 0) return "Less than 1 year";
    return `${age} years old`;
  }, []);

  // Update age display when date changes
  useEffect(() => {
    if (user?.dateOfBirth) {
      setAgeDisplay(calculateAge(user.dateOfBirth));
    }
  }, [user?.dateOfBirth, calculateAge]);

  const form = useForm<UpdateUserProfile>({
    resolver: zodResolver(updateUserProfileSchema),
    defaultValues: {
      dateOfBirth: "",
      country: "",
      mobileNumber: "",
    },
  });

  // Populate form with user data when available
  useEffect(() => {
    if (user) {
      form.reset({
        dateOfBirth: user.dateOfBirth || "",
        country: user.country || "",
        mobileNumber: user.mobileNumber || "",
      });
    }
  }, [user, form]);

  // Redirect to login if not authenticated
  useEffect(() => {
    if (!isLoading && !user) {
      toast({
        title: "Unauthorized",
        description: "You are logged out. Logging in again...",
        variant: "destructive",
      });
      setTimeout(() => {
        window.location.href = "/api/login";
      }, 500);
      return;
    }
  }, [user, isLoading, toast]);

  const updateProfileMutation = useMutation({
    mutationFn: async (data: UpdateUserProfile) => {
      return await apiRequest("PUT", "/api/auth/user", data);
    },
    onSuccess: () => {
      toast({
        title: "Profile Updated",
        description: "Your profile has been successfully updated.",
      });
      queryClient.invalidateQueries({ queryKey: ["/api/auth/user"] });
    },
    onError: (error: Error) => {
      if (isUnauthorizedError(error)) {
        toast({
          title: "Unauthorized",
          description: "You are logged out. Logging in again...",
          variant: "destructive",
        });
        setTimeout(() => {
          window.location.href = "/api/login";
        }, 500);
        return;
      }
      toast({
        title: "Update Failed",
        description: error.message || "Failed to update profile. Please try again.",
        variant: "destructive",
      });
    },
  });

  const onSubmit = (data: UpdateUserProfile) => {
    updateProfileMutation.mutate(data);
  };

  if (isLoading) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center">
        <div className="animate-spin w-8 h-8 border-4 border-primary border-t-transparent rounded-full" />
      </div>
    );
  }

  if (!user) {
    return null; // Will redirect to login
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-blue-50 to-white">
      <div className="max-w-4xl mx-auto px-4 py-6">
        {/* Header */}
        <div className="flex items-center justify-between mb-8">
          <div className="flex items-center space-x-4">
            <Button
              variant="ghost"
              size="sm"
              onClick={() => window.history.back()}
              className="flex items-center space-x-2 text-gray-600 hover:text-blue-600 transition-colors duration-200"
            >
              <ArrowLeft className="w-4 h-4" />
              <span>Back</span>
            </Button>
            <div>
              <h1 className="text-2xl font-bold text-gray-900">My Profile</h1>
              <p className="text-gray-600 text-sm">Manage your account settings</p>
            </div>
          </div>
          
        </div>

        {/* Quick Stats */}
        <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
          <Card className="border-0 shadow-md bg-white/80 backdrop-blur-sm">
            <CardContent className="flex items-center space-x-3 p-4">
              <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center">
                <User className="w-6 h-6 text-blue-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">Account Type</p>
                <p className="font-semibold text-gray-900 capitalize">{user.role}</p>
              </div>
            </CardContent>
          </Card>
          
          <Card className="border-0 shadow-md bg-white/80 backdrop-blur-sm">
            <CardContent className="flex items-center space-x-3 p-4">
              <div className="w-12 h-12 bg-green-100 rounded-full flex items-center justify-center">
                <CreditCard className="w-6 h-6 text-green-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">Credit Balance</p>
                <p className="font-semibold text-green-600">0â‚¬</p>
              </div>
            </CardContent>
          </Card>
          
          <Card className="border-0 shadow-md bg-white/80 backdrop-blur-sm">
            <CardContent className="flex items-center space-x-3 p-4">
              <div className="w-12 h-12 bg-purple-100 rounded-full flex items-center justify-center">
                <Users className="w-6 h-6 text-purple-600" />
              </div>
              <div>
                <p className="text-sm text-gray-600">Referrals</p>
                <p className="font-semibold text-gray-900">{user.totalReferrals || 0}</p>
              </div>
            </CardContent>
          </Card>
        </div>

        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
          {/* Profile Information */}
          <div className="lg:col-span-2">
            <Card className="border-0 shadow-lg bg-white/90 backdrop-blur-sm">
              <CardHeader className="pb-4">
                <CardTitle className="text-lg text-gray-900">Personal Information</CardTitle>
                <CardDescription className="text-gray-600">
                  Update your profile details
                </CardDescription>
              </CardHeader>
              <CardContent>
                {/* Security Notice */}
                <div className="mb-6 p-4 bg-gradient-to-r from-green-50 to-emerald-50 rounded-xl border border-green-200">
                  <div className="flex items-center space-x-3 mb-2">
                    <Shield className="w-5 h-5 text-green-600" />
                    <h4 className="font-medium text-green-800">Private & Secure</h4>
                  </div>
                  <p className="text-sm text-green-700">Your personal information is encrypted and only visible to you. Date of birth is kept private for security.</p>
                </div>

                {/* Current Info Display with Privacy Controls */}
                <div className="mb-6 p-4 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl border border-blue-100">
                  <div className="flex items-center space-x-3">
                    <div className="w-12 h-12 bg-gradient-to-br from-blue-500 to-blue-600 rounded-full flex items-center justify-center shadow-md">
                      <User className="w-6 h-6 text-white" />
                    </div>
                    <div>
                      <h3 className="font-semibold text-gray-900">{user.firstName} {user.lastName}</h3>
                      <p className="text-sm text-gray-600">{user.email}</p>
                      <div className="flex items-center space-x-4 mt-2 text-xs text-gray-500">
                        <div className="flex items-center space-x-1">
                          <Calendar className="w-3 h-3" />
                          <span>DOB: {user.dateOfBirth || "Not set"}</span>
                        </div>
                        <div className="flex items-center space-x-1">
                          <span>Country: {user.country || "Not set"}</span>
                        </div>
                      </div>
                    </div>
                  </div>

                </div>

                <Form {...form}>
                  <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <FormField
                        control={form.control}
                        name="dateOfBirth"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="flex items-center space-x-2 text-sm font-medium text-gray-700">
                              <Calendar className="w-4 h-4 text-blue-500" />
                              <span>Date of Birth</span>
                              <Lock className="w-3 h-3 text-gray-400" />
                            </FormLabel>
                            <FormControl>
                              <div className="relative group">
                                <Input 
                                  type="date" 
                                  {...field}
                                  max={new Date().toISOString().split('T')[0]}
                                  min="1900-01-01"
                                  onFocus={() => setDateInputFocused(true)}
                                  onBlur={() => setDateInputFocused(false)}
                                  onChange={(e) => {
                                    field.onChange(e);
                                    setAgeDisplay(calculateAge(e.target.value));
                                  }}
                                  className={`rounded-lg border-gray-200 focus:border-blue-500 focus:ring-blue-500 transition-all duration-300 pl-10 pr-20 ${
                                    dateInputFocused ? 'shadow-lg scale-[1.02]' : 'shadow-sm'
                                  }`}
                                />
                                <Shield className="absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400 transition-colors duration-200 group-hover:text-blue-500" />
                                
                                {/* Age Display */}
                                {field.value && ageDisplay && (
                                  <div className="absolute right-3 top-1/2 transform -translate-y-1/2">
                                    <span className="text-xs font-medium text-blue-600 bg-blue-50 px-2 py-1 rounded-full border border-blue-200">
                                      {ageDisplay}
                                    </span>
                                  </div>
                                )}
                              </div>
                            </FormControl>
                            
                            
                            
                            
                            
                            <FormMessage />
                          </FormItem>
                        )}
                      />

                      <FormField
                        control={form.control}
                        name="country"
                        render={({ field }) => (
                          <FormItem>
                            <FormLabel className="text-sm font-medium text-gray-700">Country</FormLabel>
                            <Select onValueChange={field.onChange} value={field.value}>
                              <FormControl>
                                <SelectTrigger className="rounded-lg border-gray-200 focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200">
                                  <SelectValue placeholder="Select your country" />
                                </SelectTrigger>
                              </FormControl>
                              <SelectContent className="max-h-60">
                                <SelectItem value="AD">ðŸ‡¦ðŸ‡© Andorra</SelectItem>
                                <SelectItem value="AE">ðŸ‡¦ðŸ‡ª United Arab Emirates</SelectItem>
                                <SelectItem value="AF">ðŸ‡¦ðŸ‡« Afghanistan</SelectItem>
                                <SelectItem value="AG">ðŸ‡¦ðŸ‡¬ Antigua and Barbuda</SelectItem>
                                <SelectItem value="AI">ðŸ‡¦ðŸ‡® Anguilla</SelectItem>
                                <SelectItem value="AL">ðŸ‡¦ðŸ‡± Albania</SelectItem>
                                <SelectItem value="AM">ðŸ‡¦ðŸ‡² Armenia</SelectItem>
                                <SelectItem value="AO">ðŸ‡¦ðŸ‡´ Angola</SelectItem>
                                <SelectItem value="AQ">ðŸ‡¦ðŸ‡¶ Antarctica</SelectItem>
                                <SelectItem value="AR">ðŸ‡¦ðŸ‡· Argentina</SelectItem>
                                <SelectItem value="AS">ðŸ‡¦ðŸ‡¸ American Samoa</SelectItem>
                                <SelectItem value="AT">ðŸ‡¦ðŸ‡¹ Austria</SelectItem>
                                <SelectItem value="AU">ðŸ‡¦ðŸ‡º Australia</SelectItem>
                                <SelectItem value="AW">ðŸ‡¦ðŸ‡¼ Aruba</SelectItem>
                                <SelectItem value="AX">ðŸ‡¦ðŸ‡½ Ã…land Islands</SelectItem>
                                <SelectItem value="AZ">ðŸ‡¦ðŸ‡¿ Azerbaijan</SelectItem>
                                <SelectItem value="BA">ðŸ‡§ðŸ‡¦ Bosnia and Herzegovina</SelectItem>
                                <SelectItem value="BB">ðŸ‡§ðŸ‡§ Barbados</SelectItem>
                                <SelectItem value="BD">ðŸ‡§ðŸ‡© Bangladesh</SelectItem>
                                <SelectItem value="BE">ðŸ‡§ðŸ‡ª Belgium</SelectItem>
                                <SelectItem value="BF">ðŸ‡§ðŸ‡« Burkina Faso</SelectItem>
                                <SelectItem value="BG">ðŸ‡§ðŸ‡¬ Bulgaria</SelectItem>
                                <SelectItem value="BH">ðŸ‡§ðŸ‡­ Bahrain</SelectItem>
                                <SelectItem value="BI">ðŸ‡§ðŸ‡® Burundi</SelectItem>
                                <SelectItem value="BJ">ðŸ‡§ðŸ‡¯ Benin</SelectItem>
                                <SelectItem value="BL">ðŸ‡§ðŸ‡± Saint BarthÃ©lemy</SelectItem>
                                <SelectItem value="BM">ðŸ‡§ðŸ‡² Bermuda</SelectItem>
                                <SelectItem value="BN">ðŸ‡§ðŸ‡³ Brunei</SelectItem>
                                <SelectItem value="BO">ðŸ‡§ðŸ‡´ Bolivia</SelectItem>
                                <SelectItem value="BR">ðŸ‡§ðŸ‡· Brazil</SelectItem>
                                <SelectItem value="BS">ðŸ‡§ðŸ‡¸ Bahamas</SelectItem>
                                <SelectItem value="BT">ðŸ‡§ðŸ‡¹ Bhutan</SelectItem>
                                <SelectItem value="BV">ðŸ‡§ðŸ‡» Bouvet Island</SelectItem>
                                <SelectItem value="BW">ðŸ‡§ðŸ‡¼ Botswana</SelectItem>
                                <SelectItem value="BY">ðŸ‡§ðŸ‡¾ Belarus</SelectItem>
                                <SelectItem value="BZ">ðŸ‡§ðŸ‡¿ Belize</SelectItem>
                                <SelectItem value="CA">ðŸ‡¨ðŸ‡¦ Canada</SelectItem>
                                <SelectItem value="CC">ðŸ‡¨ðŸ‡¨ Cocos Islands</SelectItem>
                                <SelectItem value="CD">ðŸ‡¨ðŸ‡© Democratic Republic of the Congo</SelectItem>
                                <SelectItem value="CF">ðŸ‡¨ðŸ‡« Central African Republic</SelectItem>
                                <SelectItem value="CG">ðŸ‡¨ðŸ‡¬ Republic of the Congo</SelectItem>
                                <SelectItem value="CH">ðŸ‡¨ðŸ‡­ Switzerland</SelectItem>
                                <SelectItem value="CI">ðŸ‡¨ðŸ‡® CÃ´te d'Ivoire</SelectItem>
                                <SelectItem value="CK">ðŸ‡¨ðŸ‡° Cook Islands</SelectItem>
                                <SelectItem value="CL">ðŸ‡¨ðŸ‡± Chile</SelectItem>
                                <SelectItem value="CM">ðŸ‡¨ðŸ‡² Cameroon</SelectItem>
                                <SelectItem value="CN">ðŸ‡¨ðŸ‡³ China</SelectItem>
                                <SelectItem value="CO">ðŸ‡¨ðŸ‡´ Colombia</SelectItem>
                                <SelectItem value="CR">ðŸ‡¨ðŸ‡· Costa Rica</SelectItem>
                                <SelectItem value="CU">ðŸ‡¨ðŸ‡º Cuba</SelectItem>
                                <SelectItem value="CV">ðŸ‡¨ðŸ‡» Cape Verde</SelectItem>
                                <SelectItem value="CW">ðŸ‡¨ðŸ‡¼ CuraÃ§ao</SelectItem>
                                <SelectItem value="CX">ðŸ‡¨ðŸ‡½ Christmas Island</SelectItem>
                                <SelectItem value="CY">ðŸ‡¨ðŸ‡¾ Cyprus</SelectItem>
                                <SelectItem value="CZ">ðŸ‡¨ðŸ‡¿ Czech Republic</SelectItem>
                                <SelectItem value="DE">ðŸ‡©ðŸ‡ª Germany</SelectItem>
                                <SelectItem value="DJ">ðŸ‡©ðŸ‡¯ Djibouti</SelectItem>
                                <SelectItem value="DK">ðŸ‡©ðŸ‡° Denmark</SelectItem>
                                <SelectItem value="DM">ðŸ‡©ðŸ‡² Dominica</SelectItem>
                                <SelectItem value="DO">ðŸ‡©ðŸ‡´ Dominican Republic</SelectItem>
                                <SelectItem value="DZ">ðŸ‡©ðŸ‡¿ Algeria</SelectItem>
                                <SelectItem value="EC">ðŸ‡ªðŸ‡¨ Ecuador</SelectItem>
                                <SelectItem value="EE">ðŸ‡ªðŸ‡ª Estonia</SelectItem>
                                <SelectItem value="EG">ðŸ‡ªðŸ‡¬ Egypt</SelectItem>
                                <SelectItem value="EH">ðŸ‡ªðŸ‡­ Western Sahara</SelectItem>
                                <SelectItem value="ER">ðŸ‡ªðŸ‡· Eritrea</SelectItem>
                                <SelectItem value="ES">ðŸ‡ªðŸ‡¸ Spain</SelectItem>
                                <SelectItem value="ET">ðŸ‡ªðŸ‡¹ Ethiopia</SelectItem>
                                <SelectItem value="FI">ðŸ‡«ðŸ‡® Finland</SelectItem>
                                <SelectItem value="FJ">ðŸ‡«ðŸ‡¯ Fiji</SelectItem>
                                <SelectItem value="FK">ðŸ‡«ðŸ‡° Falkland Islands</SelectItem>
                                <SelectItem value="FM">ðŸ‡«ðŸ‡² Micronesia</SelectItem>
                                <SelectItem value="FO">ðŸ‡«ðŸ‡´ Faroe Islands</SelectItem>
                                <SelectItem value="FR">ðŸ‡«ðŸ‡· France</SelectItem>
                                <SelectItem value="GA">ðŸ‡¬ðŸ‡¦ Gabon</SelectItem>
                                <SelectItem value="GB">ðŸ‡¬ðŸ‡§ United Kingdom</SelectItem>
                                <SelectItem value="GD">ðŸ‡¬ðŸ‡© Grenada</SelectItem>
                                <SelectItem value="GE">ðŸ‡¬ðŸ‡ª Georgia</SelectItem>
                                <SelectItem value="GF">ðŸ‡¬ðŸ‡« French Guiana</SelectItem>
                                <SelectItem value="GG">ðŸ‡¬ðŸ‡¬ Guernsey</SelectItem>
                                <SelectItem value="GH">ðŸ‡¬ðŸ‡­ Ghana</SelectItem>
                                <SelectItem value="GI">ðŸ‡¬ðŸ‡® Gibraltar</SelectItem>
                                <SelectItem value="GL">ðŸ‡¬ðŸ‡± Greenland</SelectItem>
                                <SelectItem value="GM">ðŸ‡¬ðŸ‡² Gambia</SelectItem>
                                <SelectItem value="GN">ðŸ‡¬ðŸ‡³ Guinea</SelectItem>
                                <SelectItem value="GP">ðŸ‡¬ðŸ‡µ Guadeloupe</SelectItem>
                                <SelectItem value="GQ">ðŸ‡¬ðŸ‡¶ Equatorial Guinea</SelectItem>
                                <SelectItem value="GR">ðŸ‡¬ðŸ‡· Greece</SelectItem>
                                <SelectItem value="GS">ðŸ‡¬ðŸ‡¸ South Georgia</SelectItem>
                                <SelectItem value="GT">ðŸ‡¬ðŸ‡¹ Guatemala</SelectItem>
                                <SelectItem value="GU">ðŸ‡¬ðŸ‡º Guam</SelectItem>
                                <SelectItem value="GW">ðŸ‡¬ðŸ‡¼ Guinea-Bissau</SelectItem>
                                <SelectItem value="GY">ðŸ‡¬ðŸ‡¾ Guyana</SelectItem>
                                <SelectItem value="HK">ðŸ‡­ðŸ‡° Hong Kong</SelectItem>
                                <SelectItem value="HM">ðŸ‡­ðŸ‡² Heard Island</SelectItem>
                                <SelectItem value="HN">ðŸ‡­ðŸ‡³ Honduras</SelectItem>
                                <SelectItem value="HR">ðŸ‡­ðŸ‡· Croatia</SelectItem>
                                <SelectItem value="HT">ðŸ‡­ðŸ‡¹ Haiti</SelectItem>
                                <SelectItem value="HU">ðŸ‡­ðŸ‡º Hungary</SelectItem>
                                <SelectItem value="ID">ðŸ‡®ðŸ‡© Indonesia</SelectItem>
                                <SelectItem value="IE">ðŸ‡®ðŸ‡ª Ireland</SelectItem>
                                <SelectItem value="IL">ðŸ‡®ðŸ‡± Israel</SelectItem>
                                <SelectItem value="IM">ðŸ‡®ðŸ‡² Isle of Man</SelectItem>
                                <SelectItem value="IN">ðŸ‡®ðŸ‡³ India</SelectItem>
                                <SelectItem value="IO">ðŸ‡®ðŸ‡´ British Indian Ocean Territory</SelectItem>
                                <SelectItem value="IQ">ðŸ‡®ðŸ‡¶ Iraq</SelectItem>
                                <SelectItem value="IR">ðŸ‡®ðŸ‡· Iran</SelectItem>
                                <SelectItem value="IS">ðŸ‡®ðŸ‡¸ Iceland</SelectItem>
                                <SelectItem value="IT">ðŸ‡®ðŸ‡¹ Italy</SelectItem>
                                <SelectItem value="JE">ðŸ‡¯ðŸ‡ª Jersey</SelectItem>
                                <SelectItem value="JM">ðŸ‡¯ðŸ‡² Jamaica</SelectItem>
                                <SelectItem value="JO">ðŸ‡¯ðŸ‡´ Jordan</SelectItem>
                                <SelectItem value="JP">ðŸ‡¯ðŸ‡µ Japan</SelectItem>
                                <SelectItem value="KE">ðŸ‡°ðŸ‡ª Kenya</SelectItem>
                                <SelectItem value="KG">ðŸ‡°ðŸ‡¬ Kyrgyzstan</SelectItem>
                                <SelectItem value="KH">ðŸ‡°ðŸ‡­ Cambodia</SelectItem>
                                <SelectItem value="KI">ðŸ‡°ðŸ‡® Kiribati</SelectItem>
                                <SelectItem value="KM">ðŸ‡°ðŸ‡² Comoros</SelectItem>
                                <SelectItem value="KN">ðŸ‡°ðŸ‡³ Saint Kitts and Nevis</SelectItem>
                                <SelectItem value="KP">ðŸ‡°ðŸ‡µ North Korea</SelectItem>
                                <SelectItem value="KR">ðŸ‡°ðŸ‡· South Korea</SelectItem>
                                <SelectItem value="KW">ðŸ‡°ðŸ‡¼ Kuwait</SelectItem>
                                <SelectItem value="KY">ðŸ‡°ðŸ‡¾ Cayman Islands</SelectItem>
                                <SelectItem value="KZ">ðŸ‡°ðŸ‡¿ Kazakhstan</SelectItem>
                                <SelectItem value="LA">ðŸ‡±ðŸ‡¦ Laos</SelectItem>
                                <SelectItem value="LB">ðŸ‡±ðŸ‡§ Lebanon</SelectItem>
                                <SelectItem value="LC">ðŸ‡±ðŸ‡¨ Saint Lucia</SelectItem>
                                <SelectItem value="LI">ðŸ‡±ðŸ‡® Liechtenstein</SelectItem>
                                <SelectItem value="LK">ðŸ‡±ðŸ‡° Sri Lanka</SelectItem>
                                <SelectItem value="LR">ðŸ‡±ðŸ‡· Liberia</SelectItem>
                                <SelectItem value="LS">ðŸ‡±ðŸ‡¸ Lesotho</SelectItem>
                                <SelectItem value="LT">ðŸ‡±ðŸ‡¹ Lithuania</SelectItem>
                                <SelectItem value="LU">ðŸ‡±ðŸ‡º Luxembourg</SelectItem>
                                <SelectItem value="LV">ðŸ‡±ðŸ‡» Latvia</SelectItem>
                                <SelectItem value="LY">ðŸ‡±ðŸ‡¾ Libya</SelectItem>
                                <SelectItem value="MA">ðŸ‡²ðŸ‡¦ Morocco</SelectItem>
                                <SelectItem value="MC">ðŸ‡²ðŸ‡¨ Monaco</SelectItem>
                                <SelectItem value="MD">ðŸ‡²ðŸ‡© Moldova</SelectItem>
                                <SelectItem value="ME">ðŸ‡²ðŸ‡ª Montenegro</SelectItem>
                                <SelectItem value="MF">ðŸ‡²ðŸ‡« Saint Martin</SelectItem>
                                <SelectItem value="MG">ðŸ‡²ðŸ‡¬ Madagascar</SelectItem>
                                <SelectItem value="MH">ðŸ‡²ðŸ‡­ Marshall Islands</SelectItem>
                                <SelectItem value="MK">ðŸ‡²ðŸ‡° North Macedonia</SelectItem>
                                <SelectItem value="ML">ðŸ‡²ðŸ‡± Mali</SelectItem>
                                <SelectItem value="MM">ðŸ‡²ðŸ‡² Myanmar</SelectItem>
                                <SelectItem value="MN">ðŸ‡²ðŸ‡³ Mongolia</SelectItem>
                                <SelectItem value="MO">ðŸ‡²ðŸ‡´ Macao</SelectItem>
                                <SelectItem value="MP">ðŸ‡²ðŸ‡µ Northern Mariana Islands</SelectItem>
                                <SelectItem value="MQ">ðŸ‡²ðŸ‡¶ Martinique</SelectItem>
                                <SelectItem value="MR">ðŸ‡²ðŸ‡· Mauritania</SelectItem>
                                <SelectItem value="MS">ðŸ‡²ðŸ‡¸ Montserrat</SelectItem>
                                <SelectItem value="MT">ðŸ‡²ðŸ‡¹ Malta</SelectItem>
                                <SelectItem value="MU">ðŸ‡²ðŸ‡º Mauritius</SelectItem>
                                <SelectItem value="MV">ðŸ‡²ðŸ‡» Maldives</SelectItem>
                                <SelectItem value="MW">ðŸ‡²ðŸ‡¼ Malawi</SelectItem>
                                <SelectItem value="MX">ðŸ‡²ðŸ‡½ Mexico</SelectItem>
                                <SelectItem value="MY">ðŸ‡²ðŸ‡¾ Malaysia</SelectItem>
                                <SelectItem value="MZ">ðŸ‡²ðŸ‡¿ Mozambique</SelectItem>
                                <SelectItem value="NA">ðŸ‡³ðŸ‡¦ Namibia</SelectItem>
                                <SelectItem value="NC">ðŸ‡³ðŸ‡¨ New Caledonia</SelectItem>
                                <SelectItem value="NE">ðŸ‡³ðŸ‡ª Niger</SelectItem>
                                <SelectItem value="NF">ðŸ‡³ðŸ‡« Norfolk Island</SelectItem>
                                <SelectItem value="NG">ðŸ‡³ðŸ‡¬ Nigeria</SelectItem>
                                <SelectItem value="NI">ðŸ‡³ðŸ‡® Nicaragua</SelectItem>
                                <SelectItem value="NL">ðŸ‡³ðŸ‡± Netherlands</SelectItem>
                                <SelectItem value="NO">ðŸ‡³ðŸ‡´ Norway</SelectItem>
                                <SelectItem value="NP">ðŸ‡³ðŸ‡µ Nepal</SelectItem>
                                <SelectItem value="NR">ðŸ‡³ðŸ‡· Nauru</SelectItem>
                                <SelectItem value="NU">ðŸ‡³ðŸ‡º Niue</SelectItem>
                                <SelectItem value="NZ">ðŸ‡³ðŸ‡¿ New Zealand</SelectItem>
                                <SelectItem value="OM">ðŸ‡´ðŸ‡² Oman</SelectItem>
                                <SelectItem value="PA">ðŸ‡µðŸ‡¦ Panama</SelectItem>
                                <SelectItem value="PE">ðŸ‡µðŸ‡ª Peru</SelectItem>
                                <SelectItem value="PF">ðŸ‡µðŸ‡« French Polynesia</SelectItem>
                                <SelectItem value="PG">ðŸ‡µðŸ‡¬ Papua New Guinea</SelectItem>
                                <SelectItem value="PH">ðŸ‡µðŸ‡­ Philippines</SelectItem>
                                <SelectItem value="PK">ðŸ‡µðŸ‡° Pakistan</SelectItem>
                                <SelectItem value="PL">ðŸ‡µðŸ‡± Poland</SelectItem>
                                <SelectItem value="PM">ðŸ‡µðŸ‡² Saint Pierre and Miquelon</SelectItem>
                                <SelectItem value="PN">ðŸ‡µðŸ‡³ Pitcairn</SelectItem>
                                <SelectItem value="PR">ðŸ‡µðŸ‡· Puerto Rico</SelectItem>
                                <SelectItem value="PS">ðŸ‡µðŸ‡¸ Palestine</SelectItem>
                                <SelectItem value="PT">ðŸ‡µðŸ‡¹ Portugal</SelectItem>
                                <SelectItem value="PW">ðŸ‡µðŸ‡¼ Palau</SelectItem>
                                <SelectItem value="PY">ðŸ‡µðŸ‡¾ Paraguay</SelectItem>
                                <SelectItem value="QA">ðŸ‡¶ðŸ‡¦ Qatar</SelectItem>
                                <SelectItem value="RE">ðŸ‡·ðŸ‡ª RÃ©union</SelectItem>
                                <SelectItem value="RO">ðŸ‡·ðŸ‡´ Romania</SelectItem>
                                <SelectItem value="RS">ðŸ‡·ðŸ‡¸ Serbia</SelectItem>
                                <SelectItem value="RU">ðŸ‡·ðŸ‡º Russia</SelectItem>
                                <SelectItem value="RW">ðŸ‡·ðŸ‡¼ Rwanda</SelectItem>
                                <SelectItem value="SA">ðŸ‡¸ðŸ‡¦ Saudi Arabia</SelectItem>
                                <SelectItem value="SB">ðŸ‡¸ðŸ‡§ Solomon Islands</SelectItem>
                                <SelectItem value="SC">ðŸ‡¸ðŸ‡¨ Seychelles</SelectItem>
                                <SelectItem value="SD">ðŸ‡¸ðŸ‡© Sudan</SelectItem>
                                <SelectItem value="SE">ðŸ‡¸ðŸ‡ª Sweden</SelectItem>
                                <SelectItem value="SG">ðŸ‡¸ðŸ‡¬ Singapore</SelectItem>
                                <SelectItem value="SH">ðŸ‡¸ðŸ‡­ Saint Helena</SelectItem>
                                <SelectItem value="SI">ðŸ‡¸ðŸ‡® Slovenia</SelectItem>
                                <SelectItem value="SJ">ðŸ‡¸ðŸ‡¯ Svalbard and Jan Mayen</SelectItem>
                                <SelectItem value="SK">ðŸ‡¸ðŸ‡° Slovakia</SelectItem>
                                <SelectItem value="SL">ðŸ‡¸ðŸ‡± Sierra Leone</SelectItem>
                                <SelectItem value="SM">ðŸ‡¸ðŸ‡² San Marino</SelectItem>
                                <SelectItem value="SN">ðŸ‡¸ðŸ‡³ Senegal</SelectItem>
                                <SelectItem value="SO">ðŸ‡¸ðŸ‡´ Somalia</SelectItem>
                                <SelectItem value="SR">ðŸ‡¸ðŸ‡· Suriname</SelectItem>
                                <SelectItem value="SS">ðŸ‡¸ðŸ‡¸ South Sudan</SelectItem>
                                <SelectItem value="ST">ðŸ‡¸ðŸ‡¹ SÃ£o TomÃ© and PrÃ­ncipe</SelectItem>
                                <SelectItem value="SV">ðŸ‡¸ðŸ‡» El Salvador</SelectItem>
                                <SelectItem value="SX">ðŸ‡¸ðŸ‡½ Sint Maarten</SelectItem>
                                <SelectItem value="SY">ðŸ‡¸ðŸ‡¾ Syria</SelectItem>
                                <SelectItem value="SZ">ðŸ‡¸ðŸ‡¿ Eswatini</SelectItem>
                                <SelectItem value="TC">ðŸ‡¹ðŸ‡¨ Turks and Caicos Islands</SelectItem>
                                <SelectItem value="TD">ðŸ‡¹ðŸ‡© Chad</SelectItem>
                                <SelectItem value="TF">ðŸ‡¹ðŸ‡« French Southern Territories</SelectItem>
                                <SelectItem value="TG">ðŸ‡¹ðŸ‡¬ Togo</SelectItem>
                                <SelectItem value="TH">ðŸ‡¹ðŸ‡­ Thailand</SelectItem>
                                <SelectItem value="TJ">ðŸ‡¹ðŸ‡¯ Tajikistan</SelectItem>
                                <SelectItem value="TK">ðŸ‡¹ðŸ‡° Tokelau</SelectItem>
                                <SelectItem value="TL">ðŸ‡¹ðŸ‡± Timor-Leste</SelectItem>
                                <SelectItem value="TM">ðŸ‡¹ðŸ‡² Turkmenistan</SelectItem>
                                <SelectItem value="TN">ðŸ‡¹ðŸ‡³ Tunisia</SelectItem>
                                <SelectItem value="TO">ðŸ‡¹ðŸ‡´ Tonga</SelectItem>
                                <SelectItem value="TR">ðŸ‡¹ðŸ‡· Turkey</SelectItem>
                                <SelectItem value="TT">ðŸ‡¹ðŸ‡¹ Trinidad and Tobago</SelectItem>
                                <SelectItem value="TV">ðŸ‡¹ðŸ‡» Tuvalu</SelectItem>
                                <SelectItem value="TW">ðŸ‡¹ðŸ‡¼ Taiwan</SelectItem>
                                <SelectItem value="TZ">ðŸ‡¹ðŸ‡¿ Tanzania</SelectItem>
                                <SelectItem value="UA">ðŸ‡ºðŸ‡¦ Ukraine</SelectItem>
                                <SelectItem value="UG">ðŸ‡ºðŸ‡¬ Uganda</SelectItem>
                                <SelectItem value="UM">ðŸ‡ºðŸ‡² United States Minor Outlying Islands</SelectItem>
                                <SelectItem value="US">ðŸ‡ºðŸ‡¸ United States</SelectItem>
                                <SelectItem value="UY">ðŸ‡ºðŸ‡¾ Uruguay</SelectItem>
                                <SelectItem value="UZ">ðŸ‡ºðŸ‡¿ Uzbekistan</SelectItem>
                                <SelectItem value="VA">ðŸ‡»ðŸ‡¦ Vatican City</SelectItem>
                                <SelectItem value="VC">ðŸ‡»ðŸ‡¨ Saint Vincent and the Grenadines</SelectItem>
                                <SelectItem value="VE">ðŸ‡»ðŸ‡ª Venezuela</SelectItem>
                                <SelectItem value="VG">ðŸ‡»ðŸ‡¬ British Virgin Islands</SelectItem>
                                <SelectItem value="VI">ðŸ‡»ðŸ‡® U.S. Virgin Islands</SelectItem>
                                <SelectItem value="VN">ðŸ‡»ðŸ‡³ Vietnam</SelectItem>
                                <SelectItem value="VU">ðŸ‡»ðŸ‡º Vanuatu</SelectItem>
                                <SelectItem value="WF">ðŸ‡¼ðŸ‡« Wallis and Futuna</SelectItem>
                                <SelectItem value="WS">ðŸ‡¼ðŸ‡¸ Samoa</SelectItem>
                                <SelectItem value="YE">ðŸ‡¾ðŸ‡ª Yemen</SelectItem>
                                <SelectItem value="YT">ðŸ‡¾ðŸ‡¹ Mayotte</SelectItem>
                                <SelectItem value="ZA">ðŸ‡¿ðŸ‡¦ South Africa</SelectItem>
                                <SelectItem value="ZM">ðŸ‡¿ðŸ‡² Zambia</SelectItem>
                                <SelectItem value="ZW">ðŸ‡¿ðŸ‡¼ Zimbabwe</SelectItem>
                              </SelectContent>
                            </Select>
                            <FormMessage />
                          </FormItem>
                        )}
                      />
                    </div>

                    <FormField
                      control={form.control}
                      name="mobileNumber"
                      render={({ field }) => (
                        <FormItem>
                          <FormLabel className="text-sm font-medium text-gray-700">Mobile Number</FormLabel>
                          <FormControl>
                            <Input 
                              placeholder="+1 (555) 123-4567" 
                              {...field} 
                              className="rounded-lg border-gray-200 focus:border-blue-500 focus:ring-blue-500 transition-colors duration-200"
                            />
                          </FormControl>
                          <FormMessage />
                        </FormItem>
                      )}
                    />

                    <div className="pt-4">
                      <Button
                        type="submit"
                        disabled={updateProfileMutation.isPending}
                        className="w-full bg-gradient-to-r from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white font-medium py-2.5 rounded-lg transition-all duration-200 shadow-md hover:shadow-lg"
                      >
                        {updateProfileMutation.isPending ? (
                          <div className="flex items-center space-x-2">
                            <div className="w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"></div>
                            <span>Updating...</span>
                          </div>
                        ) : (
                          "Update Profile"
                        )}
                      </Button>
                    </div>
                  </form>
                </Form>
              </CardContent>
            </Card>
          </div>

          {/* Referral Section */}
          <div>
            <Card className="border-0 shadow-lg bg-white/90 backdrop-blur-sm">
              <CardHeader className="pb-4">
                <CardTitle className="flex items-center space-x-2 text-lg text-gray-900">
                  <Gift className="w-5 h-5 text-purple-600" />
                  <span>Referral Code</span>
                </CardTitle>
                <CardDescription className="text-gray-600">
                  Share and earn rewards
                </CardDescription>
              </CardHeader>
              <CardContent className="space-y-4">
                <div className="p-4 bg-gradient-to-r from-purple-50 to-pink-50 rounded-xl border border-purple-100">
                  <div className="mb-2">
                    <Input
                      value={user.referralCode || ""}
                      readOnly
                      type="text"
                      className="font-mono text-center border-0 bg-white/70 text-gray-900 font-semibold"
                    />
                  </div>
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      if (user.referralCode) {
                        navigator.clipboard.writeText(user.referralCode);
                        toast({
                          title: "Copied!",
                          description: "Referral code copied to clipboard",
                        });
                      }
                    }}
                    className="w-full mt-2 bg-white/80 hover:bg-white border-purple-200 text-purple-700 hover:text-purple-800"
                  >
                    Copy Code
                  </Button>
                </div>

                {user.referrerName && (
                  <div className="p-3 bg-gradient-to-r from-green-50 to-emerald-50 rounded-lg border border-green-200">
                    <p className="text-sm text-green-800">
                      <span className="font-medium">Referred by:</span> {user.referrerName}
                    </p>
                  </div>
                )}

                <div className="pt-2 text-center">
                  <p className="text-xs text-gray-500">
                    Member since {user.createdAt ? new Date(user.createdAt as unknown as string).toLocaleDateString() : 'N/A'}
                  </p>
                </div>
              </CardContent>
            </Card>
          </div>
        </div>
      </div>
    </div>
  );
}